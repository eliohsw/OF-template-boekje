\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{packages/set-code}[2026/01/12 v0.4.4 Code Listing Settings]

% ========================================================================

\RequirePackage{xcolor}
\RequirePackage{tcolorbox}
\RequirePackage{listings}
\RequirePackage{minted}

\RequirePackage{kvoptions}

\SetupKeyvalOptions{
  family=set-code,
  prefix=setcode@
}

\DeclareStringOption[default]{style}

\ProcessKeyvalOptions*\relax

% Auto-generate custom minted style files when a local injector is available.
\edef\setcode@style@normalized{\detokenize\expandafter{\setcode@style}}
\ifx\setcode@style@normalized\@empty
  \relax
\else
  \IfFileExists{script/mint_injector.py}{%
    \immediate\write18{mkdir -p _minted && python3 script/mint_injector.py --style \setcode@style@normalized\space --texfile \jobname.tex}%
  }{}%
\fi

% ========================================================================

\ifx\setcode@style@normalized\@empty
  \relax
\else
  \edef\@temp{
    \noexpand\setminted{style=\setcode@style@normalized}
  }
  \@temp
\fi

\definecolor{custom-gray}{HTML}{B5B5AC}

\tcbuselibrary{listings, minted, skins, breakable}

\tcbset{listing engine=minted}

% The default font of the numbering in minted environments
\renewcommand{\theFancyVerbLine}{\sffamily{\scriptsize\arabic{FancyVerbLine}}}

\setmintedinline{
  fontsize=\small,
  baselinestretch=1.15,
  highlightcolor=RoyalBlue1!12.5,
  % bgcolor=gray!8.75,
}

\setminted{
  fontsize=\footnotesize,
  baselinestretch=1.15,
  highlightcolor=RoyalBlue1!12.5,
}

\newtcblisting{codelisting}[2]{
  enhanced jigsaw, empty,
  listing only,
  minted language=#1,
  minted options={
    linenos,
    numbersep=12pt,
    breaklines,
    breaksymbol=\rule{0pt}{0pt},
    breaksymbolindent=2ex,
    fontsize=\footnotesize,
    obeytabs,
    tabsize=2,
    baselinestretch=1.15,
    highlightcolor=RoyalBlue1!12.5,
    #2
  },
  colback=gray!8.75, opacityback=0,
  sharp corners,
  borderline west={0.6pt}{0pt}{black},
  left=2.5pt, right=2.5pt,
  top=0pt, bottom=0pt,
  breakable,
  toprule at break=0mm, bottomrule at break=0mm,
}
