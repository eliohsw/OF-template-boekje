\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{packages/set-fonts}[2026/01/03 v0.3.1 Minimal Fonts setup]

\RequirePackage{iftex}
\ifPDFTeX
  \PackageError{set-fonts}{This package requires XeLaTeX or LuaLaTeX}{%
    Use \string\xelatex\space or \string\lualatex.}
\fi

\RequirePackage[no-math]{fontspec}
\defaultfontfeatures{Ligatures=TeX, Scale=MatchLowercase}

\RequirePackage{xeCJK}

\RequirePackage{etoolbox}
\makeatletter
\newcommand*\SetFontIfAvailable[2]{%
  \def\sf@found{0}%
  \def\sf@chosen{}%
  \@for\sf@name:=#2\do{%
    \ifnum\sf@found=0\relax
      \IfFontExistsTF{\sf@name}{%
        \def\sf@found{1}\edef\sf@chosen{\sf@name}%
      }{}%
    \fi
  }%
  \ifnum\sf@found=1\relax
    #1{\sf@chosen}%
  \else
    \PackageWarning{set-fonts}{None of these fonts were found: #2. Using defaults.}%
  \fi
}
\makeatother

\makeatletter
\newcommand*\PickFirstFontIfAvailable[2]{%
  % #1: macro to receive chosen font name (expanded), #2: comma-separated list
  \def\sf@found{0}%
  \def\sf@chosen{}%
  \@for\sf@name:=#2\do{%
    \ifnum\sf@found=0\relax
      \IfFontExistsTF{\sf@name}{%
        \def\sf@found{1}\edef\sf@chosen{\sf@name}%
      }{}%
    \fi
  }%
  \ifnum\sf@found=1\relax
    \edef#1{\sf@chosen}%
  \else
    \edef#1{}%
  \fi
}
\makeatother


\makeatletter
\SetFontIfAvailable{\setmainfont}{%
CMU Serif,%
Times New Roman,%
STIX Two Text,%
TeX Gyre Termes,%
Latin Modern Roman%
}

% Configure sans font and the \SourceSans family in one place.
% If Source Sans 3 is installed, also try to enable a real semibold series.
\IfFontExistsTF{Source Sans 3}{%
  \PickFirstFontIfAvailable\sf@ss@sb{%
Source Sans 3 Semibold,%
Source Sans 3 SemiBold,%
SourceSans3-Semibold%
  }%
  \PickFirstFontIfAvailable\sf@ss@sbi{%
Source Sans 3 Semibold Italic,%
Source Sans 3 SemiBold Italic,%
SourceSans3-SemiboldIt%
  }%
  \ifx\sf@ss@sb\@empty
    \setsansfont{Source Sans 3}%
    \newfontfamily\SourceSans{Source Sans 3}%
    \DeclareRobustCommand{\sbseries}{\bfseries}%
    \DeclareTextFontCommand{\textsb}{\sbseries}%
    \PackageWarning{set-fonts}{Source Sans 3 found, but no Semibold face found; \string\sbseries will fall back to \string\bfseries}%
  \else
    \ifx\sf@ss@sbi\@empty
      \setsansfont[
        FontFace = {sb}{n}{\sf@ss@sb},
        FontFace = {sbx}{n}{\sf@ss@sb}
      ]{Source Sans 3}%
      \newfontfamily\SourceSans[
        Font = {Source Sans 3},
        FontFace = {sb}{n}{\sf@ss@sb},
        FontFace = {sbx}{n}{\sf@ss@sb}
      ]{Source Sans 3}%
      \DeclareRobustCommand{\sbseries}{\fontseries{sb}\selectfont}%
      \DeclareTextFontCommand{\textsb}{\sbseries}%
      \PackageWarning{set-fonts}{Source Sans 3 Semibold found, but no Semibold Italic face found}%
    \else
      \setsansfont[
        FontFace = {sb}{n}{\sf@ss@sb},
        FontFace = {sb}{it}{\sf@ss@sbi},
        FontFace = {sbx}{n}{\sf@ss@sb},
        FontFace = {sbx}{it}{\sf@ss@sbi}
      ]{Source Sans 3}%
      \newfontfamily\SourceSans[
        Font = {Source Sans 3},
        FontFace = {sb}{n}{\sf@ss@sb},
        FontFace = {sb}{it}{\sf@ss@sbi},
        FontFace = {sbx}{n}{\sf@ss@sb},
        FontFace = {sbx}{it}{\sf@ss@sbi}
      ]{Source Sans 3}%
      \DeclareRobustCommand{\sbseries}{\fontseries{sb}\selectfont}%
      \DeclareTextFontCommand{\textsb}{\sbseries}%
    \fi
  \fi
}{%
  \PickFirstFontIfAvailable\sf@fallbackSans{%
Helvetica Neue,%
Arial,%
Inter,%
TeX Gyre Heros,%
Latin Modern Sans%
  }%
  \ifx\sf@fallbackSans\@empty
    \setsansfont{Latin Modern Sans}%
    \newfontfamily\SourceSans{Latin Modern Sans}%
    \PackageWarning{set-fonts}{None of these sans fonts were found: Helvetica Neue, Arial, Inter, TeX Gyre Heros, Latin Modern Sans. Using defaults.}%
  \else
    \setsansfont{\sf@fallbackSans}%
    \newfontfamily\SourceSans{\sf@fallbackSans}%
  \fi
  \DeclareRobustCommand{\sbseries}{\bfseries}%
  \DeclareTextFontCommand{\textsb}{\sbseries}%
}

\SetFontIfAvailable{\setmonofont}{%
SF Mono,%
Source Code Pro,%
Menlo,%
Latin Modern Mono%
}
\makeatother


\makeatletter
\SetFontIfAvailable{\setCJKmainfont}{%
TW-MOE-Std-Kai,%
Source Han Serif TC,%
Source Han Serif SC,%
Noto Serif CJK TC,%
Noto Serif CJK SC,%
FandolKai,%
FandolSong%
}
\SetFontIfAvailable{\setCJKsansfont}{%
Source Han Sans TC,%
Source Han Sans SC,%
Noto Sans CJK TC,%
Noto Sans CJK SC,%
FandolHei%
}
\SetFontIfAvailable{\setCJKmonofont}{%
Source Han Sans TC,%
Source Han Sans SC,%
Noto Sans Mono CJK TC,%
Noto Sans Mono CJK SC,%
FandolFang%
}
\makeatother

\newfontfamily\Arial{Arial}
\newfontfamily\BebasNeue[Scale=MatchUppercase]{Bebas Neue}
\newfontfamily\TeXGyreHeros{TeX Gyre Heros}
\newfontfamily\TimesNewRoman{Times New Roman}

\xeCJKsetup{
  CJKmath=true,
  PunctStyle=kaiming,
  RubberPunctSkip=true
}
