\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{packages/set-fonts}[2026/01/03 v0.4.5 Minimal Fonts setup]

\RequirePackage{iftex}
\ifPDFTeX
  \PackageError{set-fonts}{This package requires XeLaTeX or LuaLaTeX}{%
    Use \string\xelatex\space or \string\lualatex.}
\fi

\RequirePackage[no-math]{fontspec}
\defaultfontfeatures{Ligatures=TeX, Scale=MatchUppercase}
\defaultfontfeatures[CJK]{Scale=MatchLowercase}

% ========================================================================
% CJK support
%   XeLaTeX: use xeCJK
%   LuaLaTeX: xeCJK is not supported; provide clear stubs

\ifXeTeX
  \RequirePackage{xeCJK}
\else
  \newcommand\setCJKmainfont[2][]{%
    \PackageError{set-fonts}{CJK mode requires XeLaTeX (xeCJK)}{%
      You compiled with LuaLaTeX. Switch to XeLaTeX, or use a LuaLaTeX CJK
      solution (e.g. luatexja/ctex) and adapt this package accordingly.}%
  }
  \newcommand\setCJKsansfont[2][]{\setCJKmainfont[#1]{#2}}
  \newcommand\setCJKmonofont[2][]{\setCJKmainfont[#1]{#2}}
\fi

% ========================================================================
% Convenience font-switching commands (only define if font exists)

\IfFontExistsTF{Arial}
  {\newfontfamily\Arial{Arial}}
  {\providecommand\Arial{\normalfont}}

\IfFontExistsTF{Bebas Neue}
  {\newfontfamily\BebasNeue[Scale=MatchUppercase]{Bebas Neue}}
  {\providecommand\BebasNeue{\normalfont}}

\IfFontExistsTF{TeX Gyre Heros}
  {\newfontfamily\TeXGyreHeros{TeX Gyre Heros}}
  {\providecommand\TeXGyreHeros{\normalfont}}

\IfFontExistsTF{Times New Roman}
  {\newfontfamily\TimesNewRoman{Times New Roman}}
  {\providecommand\TimesNewRoman{\normalfont}}

\ifXeTeX
  \xeCJKsetup{
    CJKmath=true,
    PunctStyle=kaiming,
    RubberPunctSkip=true
  }
\fi

\DeclareRobustCommand{\sbseries}{\fontseries{sb}\selectfont}
\DeclareTextFontCommand{\textsb}{\sbseries}

% ========================================================================
% Font fallback helper
%
%   \SetFontFromList[<mode>]{<family>}{<font1, font2, ...>}
%
% - <family> : main | sans | mono
% - <mode>   : (empty) uses \setmainfont/\setsansfont/\setmonofont
%              CJK     uses \setCJKmainfont/\setCJKsansfont/\setCJKmonofont
%
% For each candidate font in the list, the first one that exists is selected.
% If none exist, the corresponding default is restored.
%
% Whitespace note:
%   Items are trimmed on both ends; empty items are ignored.

\RequirePackage{xparse}
\ExplSyntaxOn

% Save defaults at package load so we can restore later.
\tl_new:N \g__setfonts_rmdefault_tl
\tl_new:N \g__setfonts_sfdefault_tl
\tl_new:N \g__setfonts_ttdefault_tl
\tl_new:N \g__setfonts_CJKrmdefault_tl
\tl_new:N \g__setfonts_CJKsfdefault_tl
\tl_new:N \g__setfonts_CJKttdefault_tl

\cs_new_protected:Npn \__setfonts_store_defaults:
  {
    \tl_gset:Nx \g__setfonts_rmdefault_tl { \rmdefault }
    \tl_gset:Nx \g__setfonts_sfdefault_tl { \sfdefault }
    \tl_gset:Nx \g__setfonts_ttdefault_tl { \ttdefault }
    \cs_if_exist:NT \CJKrmdefault
      { \tl_gset:Nx \g__setfonts_CJKrmdefault_tl { \CJKrmdefault } }
    \cs_if_exist:NT \CJKsfdefault
      { \tl_gset:Nx \g__setfonts_CJKsfdefault_tl { \CJKsfdefault } }
    \cs_if_exist:NT \CJKttdefault
      { \tl_gset:Nx \g__setfonts_CJKttdefault_tl { \CJKttdefault } }
  }
\__setfonts_store_defaults:

% ------------------------------------------------------------------------
% CJK family naming strategy
%
% xeCJK warns when redefining an existing CJKfamily. To avoid that noise:
% - Every time we define a CJK main/sans/mono font, we first assign a fresh,
%   unique family name to \CJKrmdefault/\CJKsfdefault/\CJKttdefault.
% - Then \setCJK...font defines that *new* family, so no "redefining" warning.
%
% We also only auto-fill CJK sans/mono from the chosen CJK main font if the
% user hasn't explicitly set them via this package.

\int_new:N \g__setfonts_CJKrm_int
\int_new:N \g__setfonts_CJKsf_int
\int_new:N \g__setfonts_CJKtt_int

\bool_new:N \g__setfonts_CJKsf_user_bool
\bool_new:N \g__setfonts_CJKtt_user_bool

\cs_new_protected:Npn \__setfonts_cjk_set_family:nn #1 #2
  {
    \str_case:nnF {#1}
      {
        {main}{
          \int_gincr:N \g__setfonts_CJKrm_int
          \cs_set:Npx \CJKrmdefault { setfonts-CJKrm-\int_use:N \g__setfonts_CJKrm_int }
          \setCJKmainfont{#2}

          % Ensure CJK sans/mono exist to avoid xeCJK "Unknown CJK family" warnings,
          % but do not override a user choice.
          \bool_if:NF \g__setfonts_CJKsf_user_bool
            {
              \int_gincr:N \g__setfonts_CJKsf_int
              \cs_set:Npx \CJKsfdefault { setfonts-CJKsf-\int_use:N \g__setfonts_CJKsf_int }
              \setCJKsansfont{#2}
            }
          \bool_if:NF \g__setfonts_CJKtt_user_bool
            {
              \int_gincr:N \g__setfonts_CJKtt_int
              \cs_set:Npx \CJKttdefault { setfonts-CJKtt-\int_use:N \g__setfonts_CJKtt_int }
              \setCJKmonofont{#2}
            }
        }
        {sans}{
          \int_gincr:N \g__setfonts_CJKsf_int
          \cs_set:Npx \CJKsfdefault { setfonts-CJKsf-\int_use:N \g__setfonts_CJKsf_int }
          \setCJKsansfont{#2}
          \bool_gset_true:N \g__setfonts_CJKsf_user_bool
        }
        {mono}{
          \int_gincr:N \g__setfonts_CJKtt_int
          \cs_set:Npx \CJKttdefault { setfonts-CJKtt-\int_use:N \g__setfonts_CJKtt_int }
          \setCJKmonofont{#2}
          \bool_gset_true:N \g__setfonts_CJKtt_user_bool
        }
      }
      { \PackageError{set-fonts}{Unknown font family `#1'}{Use main, sans, or mono.} }
  }

% ------------------------------------------------------------------------
% Restore defaults (only for the requested family/mode).
\cs_new_protected:Npn \__setfonts_restore_defaults:nn #1 #2
  {
    \tl_if_eq:nnTF {#1} {CJK}
      {
        \str_case:nnF {#2}
          {
            {main}{\cs_if_exist:NT \CJKrmdefault {\cs_set:Npn \CJKrmdefault {\g__setfonts_CJKrmdefault_tl}}}
            {sans}{\cs_if_exist:NT \CJKsfdefault {\cs_set:Npn \CJKsfdefault {\g__setfonts_CJKsfdefault_tl}}}
            {mono}{\cs_if_exist:NT \CJKttdefault {\cs_set:Npn \CJKttdefault {\g__setfonts_CJKttdefault_tl}}}
          }
          {\PackageError{set-fonts}{Unknown font family `#2'}{Use main, sans, or mono.}}

        % Reset user-choice tracking when restoring.
        \bool_gset_false:N \g__setfonts_CJKsf_user_bool
        \bool_gset_false:N \g__setfonts_CJKtt_user_bool
        \normalfont
      }
      {
        \str_case:nnF {#2}
          {
            {main}{\cs_set:Npn \rmdefault {\g__setfonts_rmdefault_tl}}
            {sans}{\cs_set:Npn \sfdefault {\g__setfonts_sfdefault_tl}}
            {mono}{\cs_set:Npn \ttdefault {\g__setfonts_ttdefault_tl}}
          }
          {\PackageError{set-fonts}{Unknown font family `#2'}{Use main, sans, or mono.}}
        \normalfont
      }
  }

% Apply chosen font (dispatches to the right setter).
\cs_new_protected:Npn \__setfonts_apply:nnn #1 #2 #3
  {
    \tl_if_eq:nnTF {#1} {CJK}
      { \__setfonts_cjk_set_family:nn {#2} {#3} }
      {
        \str_case:nnF {#2}
          {
            {main}{\setmainfont{#3}}
            {sans}{\setsansfont{#3}}
            {mono}{\setmonofont{#3}}
          }
          {\PackageError{set-fonts}{Unknown font family `#2'}{Use main, sans, or mono.}}
      }
  }

% ------------------------------------------------------------------------
% Main selector: pick first existing font from a comma list (whitespace-safe).
\bool_new:N \l__setfonts_found_bool
\clist_new:N \l__setfonts_candidates_clist
\tl_new:N \l__setfonts_candidate_tl

\cs_new_protected:Npn \__setfonts_select_from_list:nnn #1 #2 #3
  {
    \bool_set_false:N \l__setfonts_found_bool
    \clist_set:Nn \l__setfonts_candidates_clist {#3}

    \clist_map_inline:Nn \l__setfonts_candidates_clist
      {
        \tl_set:Nn \l__setfonts_candidate_tl {##1}
        \tl_trim_spaces:N \l__setfonts_candidate_tl
        \tl_if_blank:nF { \tl_use:N \l__setfonts_candidate_tl }
          {
            \IfFontExistsTF { \tl_use:N \l__setfonts_candidate_tl }
              {
                \__setfonts_apply:nnn {#1} {#2} { \tl_use:N \l__setfonts_candidate_tl }
                \bool_set_true:N \l__setfonts_found_bool
                \clist_map_break:
              }
              { }
          }
      }

    \bool_if:NF \l__setfonts_found_bool
      { \__setfonts_restore_defaults:nn {#1} {#2} }
  }

% Public command
%   \SetFontFromList{main|sans|mono}{...}
%   \SetFontFromList[CJK]{main|sans|mono}{...}
\NewDocumentCommand \SetFontFromList { o m m }
  {
    \IfNoValueTF{#1}
      { \__setfonts_select_from_list:nnn {} {#2} {#3} }
      {
        \tl_set:Nn \l_tmpa_tl {#1}
        \tl_trim_spaces:N \l_tmpa_tl
        \tl_if_blank:nTF { \tl_use:N \l_tmpa_tl }
          { \__setfonts_select_from_list:nnn {} {#2} {#3} }
          {
            % Normalize mode: detokenize + uppercase, so [cjk] works.
            \tl_set:Nx \l_tmpa_tl { \tl_upper_case:n { \tl_to_str:N \l_tmpa_tl } }
            \str_if_eq:VnTF \l_tmpa_tl {CJK}
              { \__setfonts_select_from_list:nnn {CJK} {#2} {#3} }
              { \PackageError{set-fonts}{Unknown mode `#1'}{Only [CJK] is supported.} }
          }
      }
  }

\ExplSyntaxOff
